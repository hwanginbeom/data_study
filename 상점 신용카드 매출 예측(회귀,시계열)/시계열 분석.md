# 시계열 분석



## 시계열 분석 이론의 기초

>시계열 분석은 크게 __규칙적 시계열 분석__과 __불규칙적 시계열 분석__으로 나뉜다. 
>
>규칙적 시계열?
>
>- 트렌드와 분산이 불변하는 시계열 데이터
>
>불규칙적 시계열?
>
>- 트렌드 혹은 분산이 변화하는 시계열 데이터
>
>시계열 분석을 잘 한다는 의미
>
>: 불규칙성을 가지는 시계열 데이터에 특정한 기법이나 모델을 적용하여 규칙적 패턴을 적용하거나, 혹은 예측할 수 있도록 하는 것을 의미한다. 
>
>![](https://t1.daumcdn.net/cfile/tistory/99DE1C3C5C39D35C23)
>
>![](https://t1.daumcdn.net/cfile/tistory/990E723C5C39D35C22)
>
>불규칙성을 띠는 시계열 데이터에 규칙성을 부여하는 방법으로는 __AR, MA, ARMA, ARIMA__ 모델 등의 분석 방법을 적용하는 것이 가장 널리 알려져 있음
>
>최근에는 딥러닝을 이용하여 시계열 데이터의 연속성을 기계 스스로 찾아내도록 하는 방법이 더 좋은 성능을 내고 있음 ex) __LSTM , RNN__



## 시계열 4가지 구성요인

>1) **추세 요인 (Trend factor)** 은 인구의 변화, 자원의 변화, 자본재의 변화, 기술의 변화 등과 같은 요인들에 의해 영향을 받는 장기 변동 요인으로서, 급격한 충격이 없는 한 지속되는 특성
>
>ex)  "10년 주기의 세계경제 변동 추세" 
>
>
>
>2) **순환 요인 (Cycle factor)** 은 경제활동의 팽창과 위축과 같이 불규칙적이며 반복적인 **중기 변동요인**을 말함. 
>
>ex) 주식투자가들이 "건설업/반도체업/조선업 순환주기"를 고려해서 투자함
>
>만약 관측한 데이터셋이 10년 미만일 경우 추세 요인과 순환 요인을 구분하는 것이 매우 힘듬
>
>→ 관측기간이 길지 않을 경우 추세와 순환 요인을 구분하지 않고 그냥 묶어서 추세 요인이라고 분석하기도함
>
>
>
>3) **계절 요인 (Seasonal factor)** 은 **12개월(1년)의 주기**를 가지고 반복되는 변화를 말하며, 계절의 변화, 공휴일의 반복, 추석 명절의 반복 등 과 같은 요인들에 의하여 발생
>
>
>
>4) **불규칙 요인 (Irregular / Random factor, Noise)** 은 일정한 규칙성을 인지할 수 없는 변동의 유형을 의미천재지변, 전쟁, 질병 등과 같이 예 상할 수 없는 우연적 요인에 의해 발생되는 변동을 총칭 
>
>불규칙변동 은 경제활동에 미미한 영향을 미치기도 하지만 때로는 경제생활에 지대한 영향을 주기도 함
>
>
>
>### 시계열 구성요인간의 결합방식
>
>시계열 구성요인 간의 결합 방식에 따라서 **(1) 구성요인 간 독립적이라고 가정하여 각 구성요인을 더하는 가법 모형 (additive model)과, (2) 구성요인 간 독립적이지 않고 상호작용을 한다고 가정하여 구성요인 간 곱해주는 승법 모형 (multiplicative model)**으로 구분할 수 있습니다. 
>
>
>
>- __시계열 가법 모형 (time series additive model)__
>  = 추세 요인(trend factor) + 순환 요인(cycle factor) + 계절 요인(seasonal factor)+ 불규칙 요인(irregular/random factor)
>  : ![img](https://t1.daumcdn.net/cfile/tistory/99D99B4A5E0CA80738)
>
>- __시계열 승법 모형 (time series multiplicative model)__
>  = 추세 요인 x 순환 요인 x 계절 요인 x 불규칙 요인
>  :![img](https://t1.daumcdn.net/cfile/tistory/99608C425E11853924)
>
>출처: https://rfriend.tistory.com/509 [R, Python 분석과 프로그래밍의 친구 (by R Friend)]
>
>
>
>요인들을 하나로 합한 시각화 
>
>![](https://t1.daumcdn.net/cfile/tistory/9911DB455E0DED2807)
>
>



## 정상성과 차분

>ARMA, ARIMA 모델을 공부하기 전 __정상성__ 과 __차분__을 구하는 기법을 알아야함!!
>
>#### 정상성(Stationarity)
>
>**정상성(stationarity)**을 나타내는 시계열은 시계열의 특징이 해당 시계열이 관측된 시간에 무관
>
>따라서, 추세나 계절성이 있는 시계열은 정상성을 나타내는 시계열이 X 
>
>why?) 추세와 계절성은 서로 다른 시간에 시계열의 값에 영향을 줄 것이기 때문
>
>__백색잡음(white noise) 시계열__은 정상성을 나타내는 시계열
>
>why?)언제 관찰하는지에 상관이 없고, 시간에 따라 어떤 시점에서 보더라도 똑같이 보일 것이기 때문
>
>![](https://otexts.com/fppkr/fpp_files/figure-html/stationary-1.png)
>
>계절성 - (d), (h), (i)
>
>추세 + 수준이 변함 -  (a), (c), (e), (f), (i)
>
>분산 증가 - (i)
>
>__정상성 시계열 - (b), (g)__  시계열 (g)에서 나타나는 뚜렷한 주기(cycle) 때문에 정상성을 나타내는 시계열이 아닌 것처럼 보일 수 있습니다. 하지만 이러한 주기는 불규칙적(aperiodic)
>
>**(a) 200 거래일 동안의 구글 주식 가격; (b) 200 거래일 동안의 구글 주식 가격의 일일 변동
>
>__정상성 검정 Test__ = 단위근 
>
>- Augmented Dickey-Fuller Test (adf)
>- p-value가 0.05 보다 작으면 정상성을 가짐
>
>#### ACF(자기상관 함수)
>
>정상성을 나타내지 않는 시계열을 찾아낼 때 데이터의 시간 그래프를 살펴보는 것만큼, __ACF 그래프도 유용__합<u>정상성을 나타내지 않는 데이터에서는 ACF가 느리게 감소</u>↓하지만, <u>정상성을 나타내는 시계열에서는, ACF가 비교적 빠르게 0으로 떨어짐</u>. 그리고 정상성을 나타내지 않는 데이터에서 r1은 종종 큰 양수 값을 가짐.
>
>![](https://otexts.com/fppkr/fpp_files/figure-html/acfstationary-1.png)
>
>그래프를 살펴보면 차분 전 그래프는 positive상관성이 있고 차분 후 그래프는 무작위로 움직임
>
>- **positive한 상관** 큰 숫자로 시작해서 완만하게 떨어지는 형태임
>- **negative한 상관** : 마이너스 상관관계가 있으면 마이너스, 플러스 그래프가 나옴
>
>#### PACF
>
>- 간접적으로 영향을 주는 부분을 빼버리고, 직접적으로 영향을 주는 부분만 계산함. (순수하게 시점간 상관만 추출한 것)
>
>#### 차분(Difeerencing)
>
>: 연이은 관측값들의 차이를 계산 / 정상성을 나타내지 않는 시계열을 정상성을 나타내도록 만드는 방법
>
>ex) 로그 변환
>
>→ 차분(differencing)은 시계열의 수준에서 나타나는 변화를 제거하여 시계열의 평균 변화를 일정하게 만드는데 도움이 될 수 있음. 결과적으로 추세나 계절성이 제거(또는 감소)
>
>![](C:\Users\kim23\Desktop\머신러닝 공부\스터디1_상점 신용카드 매출 예측\시계열.JPG)
>
>이미지 출처 - https://kerpect.tistory.com/161
>
>#### 단위근 검정 
>
>- 객관적으로 차분을 구하는 것이 필요할지 결정하기 위해 사용하는 한가지 방법
>-  데이터에 정상성이 나타난다는 것이 귀무가설(null hypothesis) →결과적으로, 작은 p-값(예를 들면, 0.05보다 작은)은 차이를 구하는 것이 필요하다는 것을 나타냄



## 시계열 모델

>### ARMA 모델
>
>ARMA 모형, 또는 자기회귀이동평균 (Autoregressive Moving Average) 모형은 두 가지 다항식으로 약한 정상성을 가진 확률적 시계열을 표현하는데 사용한다. 이 두 다항식 중 첫 번째는 자기회귀(autoregressive)이며, 두 번째는 이동평균(moving average)이다.
>
>이 모형을 **ARMA(p, q)** 로 나타내기도 하며, 여기서 p와 q는 아래와 같다:
>
>- p: 자기회귀 다항식의 차수(order)
>- q: 이동평균 다항식의 차수(order)
>
>![](C:\Users\kim23\Desktop\머신러닝 공부\스터디1_상점 신용카드 매출 예측\시계열2.JPG)
>
>### ARIMA 모델
>
>차분을 구하는 것을 자기회귀와 이동 평균 모델과 결합하면, 비-계절성(non-seasonal) ARIMA 모델을 얻을수있다. ARIMA는 AutoRegressive Integrated Moving Average (이동 평균을 누적한 자기회귀)의 약자(이러한 맥락에서, “누적(integration)”은 차분의 반대 의미를 가짐)
>
>![](C:\Users\kim23\Desktop\머신러닝 공부\스터디1_상점 신용카드 매출 예측\시계열3.JPG)
>
>여기에서 y′t는 차분을 구한 시계열(한 번 이상 차분을 구한 것일수도 있음)우변의 “예측변수(predictor)”에는 yt의 시차 값과 시차 오차(lagged error) 둘 다를 포함합니다. 이것을 **ARIMA(p,d,q) 모델**이라고 한다.
>
>- p = 자기회귀 부분의 차수
>- d = 1차 차분이 포함된 정도
>- q = 이동 평균 부분의 차수
>
>| 백색잡음                 | ARIMA(0,0,0)             |
>| ------------------------ | ------------------------ |
>| 확률보행                 | 상수가 없는 ARIMA(0,1,0) |
>| 표류를 포함하는 확률보행 | 상수가 있는 ARIMA(0,1,0) |
>| 자기회귀                 | ARIMA(p,0,0)             |
>| 이동평균                 | ARIMA(0,0,q)             |
>
>차분을 구한 데이터의 __ACF와 PACF__ 그래프가 다음과 같은 패턴을 나타내면, 데이터는 ARIMA(p,d,0) 모델을 따를 수도 있다.
>
>- ACF가 지수적으로 감소하거나 사인 함수 모양인 경우
>- PACF 그래프에서 시차 p에 뾰족한 막대가 유의미하게 있지만, 시차 p이후에는 없을 때
>
>차분을 구한 데이터의 ACF와 PACF 그래프가 다음과 같은 패턴을 나타내면, 데이터는 ARIMA(0, d,q) 모델을 따를 수도 있다.
>
>- PACF가 지수적으로 감소하거나 사인 함수 모양인 경우
>- ACF 그래프에서 시차 q에 뾰족한 막대가 유의미하게 있지만, 시차 q 이후에는 없을 때
>
>#### 최대 가능도 추정
>
>모델의 차수를 찾은 다음(즉, p, d, q값), 다음과 같은 매개변수 c, ϕ1,…,ϕp, θ1,…,θq을 추정할 필요가 있다.
>
>이때 <u>최대 가능도 추정(maximum likelihood estimation) (MLE)</u>을 사용
>
>→ ARIMA 모델에서는 MLE는 최소제곱추정과 비슷
>
>#### 정보기준
>
>![](C:\Users\kim23\Desktop\머신러닝 공부\스터디1_상점 신용카드 매출 예측\시계열4.JPG)
>
>
>
>### Facebook Prophet
>
>: 페이스북이 만든 시계열 예측 라이브러리
>
>- 날짜 정보와 예측할 y만 있으면 되기 때문에 간편하면서도 성능이 좋음
>
>- Prophet의 모형은 트렌드(growth), 계절성(seasonality), 휴일(holidays) 3가지의 main components로 이루어짐
>
>  ![img](https://blog.kakaocdn.net/dn/ckx2T5/btqE0O1Y3KX/BWkezapdPL0QwtQH8TroIk/img.png)
>
>g(t) : 반복적인 요소를 가지지 않은 트렌드
>
>![](https://t1.daumcdn.net/cfile/tistory/999CE5365B17294F15)
>
>s(t) : 요일 혹은 연 계절성과 같은 반복적인 변화
>
>![](https://t1.daumcdn.net/cfile/tistory/9932F3395B175B8E0E)
>
>여기서 N을 얼만큼 넣느냐가 이슈가 되는데, 연도기준이라면 N은 10, 그리고 주단위라면 N은 3이 모든 문제에 제일 잘 들어맞는것 같다고 주장 →  파라미터를 조정도 가능 보통 N이 크면 패턴이 빠르게 바뀌게 되며, N이 작으면 느리게 변함
>
>![](https://t1.daumcdn.net/cfile/tistory/992BF1335B175E6915)
>
>![](https://t1.daumcdn.net/cfile/tistory/99CAAE335B175E6A0D)
>
>
>
>h(t) : Holiday와 같이 가끔씩 불규칙하게 영향을 미치는 요소
>
>![](https://t1.daumcdn.net/cfile/tistory/995089465B1760510D)
>
>t로 나타내어지는 특정한 시간이 우리의 휴일 리스트 D에 포함되어있음을 확인하고 이에대한 조정이 들어가며, 추가적으로 특정 휴일 주변 날들도 냅다 휴일과 마찬가지의 영향력을 가지게 파라미터 설정도 가능
>
>
>
>#### Facebook Prophet 의 장점
>
>- 유연성 : 계절성과 여러 기간들에 대한 예측을 쉽게 모델에 적용할수 있습니다. 분석가들은 여러가지를 해볼수 있음
>
>- ARIMA모델과 다르게, 모델을 차분해서 정규화 시킬필요도 없고 결측치들을 굳이 구겨넣을 이유가 없음
>
>- 훈련은 빠르고 분석가는 여러가지 상세한 모델 스펙을 탐험할수 있음
>
>- 결국에는 회귀분석과 같은 느낌이기 때문에 좀 어렵고 생소한 시계열 분석 등보다 빠르게 적응할수 있는 측면이 있음
>
>##### 모델 수정법 
>
>Baseline 모델과 비교하여 뭔가 떨어져보일때는 trend, seasonality 등을 수정하기!!
>
>\- 특정 일자에 예측률이 떨어진다면, 아웃라이어를 제거하기!!
>
>\- 특정 cutoff (연말 등) 에 예측률이 떨어진다면, changepoint를 추가하기!!
>
>
>
>출처: https://gorakgarak.tistory.com/1255 [먹거리 만드는 열정맨 고락가락]
>
>
>
>

